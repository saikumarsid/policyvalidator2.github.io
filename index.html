<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SES Policy Validator 2 (Policy Manager)</title>
<style>
body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #c2e9fb, #e2f0cb);
  margin: 0;
  padding: 20px;
  color: #333;
}
h1 {
  text-align: center;
  color: #004085;
  font-size: 2.4em;
  margin-bottom: 25px;
  text-shadow: 1px 1px 2px #ffffff;
}
.container {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  gap: 20px;
}
.input-box {
  flex: 1;
  min-width: 380px;
  max-width: 480px;
  background: linear-gradient(135deg, #ffffff, #f1f8ff);
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
}
h3 {
  color: #00796b;
  text-align: center;
  margin-top: 0;
}
textarea {
  width: 100%;
  height: 220px;
  font-family: monospace;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  resize: none;
  font-size: 14px;
  background-color: #fafafa;
}
button {
  margin-top: 12px;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background-color: #00bcd4;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
  width: 100%;
}
button:hover { background-color: #0097a7; }
.secondary-btn { width: 48%; display: inline-block; margin:2px 1% 0; }
table {
  border-collapse: collapse;
  width: 100%;
  background-color: #fff;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  margin-top: 10px;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px 10px;
  text-align: center;
  font-size: 13px;
}
th { background-color: #4a90e2; color: white; }
tr:nth-child(even) { background-color: #f4f9ff; }
.mismatch {
  background-color: #f8d7da !important;
  color: #721c24 !important;
  font-weight: bold;
}
.compare-container {
  text-align: center;
  margin-top: 25px;
}
.compare-btn { background-color: #8e44ad; color: #fff; font-weight:bold; padding:12px 20px; border:none; border-radius:8px; cursor:pointer; }
.compare-btn:hover { background-color: #6d3393; }
.result-box {
  max-width: 700px;
  margin: 25px auto;
  padding: 18px 20px;
  border-radius: 12px;
  text-align: left;
  font-weight: bold;
  font-size: 1em;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  line-height: 1.5em;
  display:none;
}
.success { background-color: #d4edda; color: #155724; border-left: 6px solid #28a745; }
.error { background-color: #f8d7da; color: #721c24; border-left: 6px solid #dc3545; }
.error ul { margin-top: 8px; padding-left: 25px; }
.edit-btn { background-color: #ff9800; margin-top: 12px; }
.edit-btn:hover { background-color: #f57c00; }
.table-title {
  text-align: center;
  font-weight: bold;
  font-size: 1.1em;
  margin-bottom: 8px;
  color: #333;
}
.compare-option {
  margin-bottom: 10px;
  font-size: 15px;
  color: #333;
}
</style>
</head>
<body>

<h1>SES Policy Validator 2 (Policy Manager)</h1>

<div class="container">
  <div class="input-box" id="box1">
    <h3>Policy Received by Mail üì©</h3>
    <textarea id="data1" placeholder="Paste vertical data here..."></textarea>
    <button onclick="convertToProcedure1(1)">Convert to Table</button>
  </div>

  <div class="input-box" id="box2">
    <h3>Updated CDN Policy Manager üì§</h3>
    <textarea id="data2" placeholder="Paste vertical or tab-separated policy here..."></textarea>
    <button onclick="convertToConvivaTable()">Convert to Table</button>
  </div>
</div>

<div class="compare-container">
  <label class="compare-option">
    <input type="checkbox" id="cfacCheck"> keep cf = ac
  </label><br>
  <button class="compare-btn" onclick="compareTables()">Compare Policies</button>
</div>

<div id="result" class="result-box"></div>

<script>
let tableData1 = [];
let tableData2 = [];

/* =======================================================================
   UPDATED applyProcedure1 WITH ONLY YOUR REQUIRED ADDITION
   ======================================================================= */
function applyProcedure1(resources) {
  resources = resources.filter(Boolean);

  const clean = [];
  for (const res of resources) {
    if (res.startsWith("A")) {
      const withoutA = res.slice(1);
      if (resources.includes(withoutA)) continue;
    }
    clean.push(res);
  }
  resources = clean;

  resources = resources.map(res => {
    let parts = res.split("-");

    /* üî• NEW RULE: Merge last segment (IT) into first segment */
    if (parts.length >= 4) {
      const last = parts[parts.length - 1];
      if (/^[A-Za-z]{2}$/.test(last)) {
        parts[0] = parts[0] + last;  
        parts.pop();
      }
    }

    /* ORIGINAL RULE UNTOUCHED */
    if (parts.length >= 3) {
      return `dc${parts[1].toLowerCase()}-${parts[0].toLowerCase()}-live`;
    }
    return res.toLowerCase();
  });

  if (resources.length >= 1) resources[0] = "a-" + resources[0];
  if (resources.length >= 2) resources[1] = "a-" + resources[1];

  return resources;
}

/* --------------------------------------------------------------------- */
/* REST OF THE CODE (UNCHANGED)                                          */
/* --------------------------------------------------------------------- */

function convertToProcedure1(boxNum) {
  const textarea = document.getElementById("data" + boxNum);
  let lines = textarea.value.trim().split(/\r?\n+/).map(l => l.trim()).filter(Boolean);
  if (!lines.length) return alert("Please paste data first!");
  const tableTitleText = lines.shift();

  const box = document.getElementById("box" + boxNum);
  textarea.style.display = "none";
  box.querySelector("button").style.display = "none";

  const titleElem = document.createElement("div");
  titleElem.className = "table-title";
  titleElem.textContent = tableTitleText;
  box.appendChild(titleElem);

  const table = document.createElement("table");
  table.innerHTML = "<tr><th>Percentage</th><th>CDN Distribution</th></tr>";

  let i = 0;
  const dataRows = [];

  while (i < lines.length) {
    let percent = lines[i];
    if (!/^\d+(\.\d+)?%?$/.test(percent)) { i++; continue; }
    percent = percent.endsWith("%") ? percent : percent + "%";
    i++;

    const resources = [];
    while (i < lines.length && !/^\d+(\.\d+)?%?$/.test(lines[i])) {
      resources.push(lines[i++]);
    }

    const procResources = applyProcedure1(resources);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${percent}</td><td>${procResources.join(", ")}</td>`;
    table.appendChild(tr);
    dataRows.push([percent, procResources.join(", ")]);
  }

  box.appendChild(table);
  tableData1 = dataRows;

  const controls = document.createElement("div");
  controls.style.textAlign = "center";
  controls.style.marginTop = "10px";

  const editBtn = document.createElement("button");
  editBtn.className = "edit-btn secondary-btn";
  editBtn.textContent = "üîÅ Edit Data";
  editBtn.onclick = () => { table.remove(); controls.remove(); titleElem.remove(); textarea.style.display = "block"; box.querySelector("button").style.display = "block"; };

  const clearBtn = document.createElement("button");
  clearBtn.className = "secondary-btn";
  clearBtn.style.backgroundColor = "#dc3545";
  clearBtn.textContent = "üßπ Clear Data";
  clearBtn.onclick = () => { table.remove(); controls.remove(); titleElem.remove(); textarea.value = ""; textarea.style.display = "block"; box.querySelector("button").style.display = "block"; tableData1 = []; };

  const copyBtn = document.createElement("button");
  copyBtn.className = "secondary-btn";
  copyBtn.style.backgroundColor = "#28a745";
  copyBtn.textContent = "üìã Copy Data";
  copyBtn.onclick = () => { const textToCopy = dataRows.map(r => r.join("\t")).join("\n"); navigator.clipboard.writeText(textToCopy); alert("‚úÖ Table data copied!"); };

  controls.append(editBtn, clearBtn, copyBtn);
  box.appendChild(controls);
}

function convertToConvivaTable() {
  const textarea = document.getElementById("data2");
  let lines = textarea.value.trim().split(/\r?\n+/).map(l => l.trim()).filter(Boolean);
  if (!lines.length) return alert("Please paste data first!");
  const tableTitleText = lines.shift();

  const box = document.getElementById("box2");
  textarea.style.display = "none";
  box.querySelector("button").style.display = "none";

  const titleElem = document.createElement("div");
  titleElem.className = "table-title";
  titleElem.textContent = tableTitleText;
  box.appendChild(titleElem);

  const table = document.createElement("table");
  table.innerHTML = "<tr><th>Percentage</th><th>CDN Distribution</th></tr>";

  const dataRows = [];
  for (let i = 0; i < lines.length; i += 2) {
    const percent = lines[i] || "";
    const cdn = lines[i + 1] || "";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${percent}</td><td>${cdn}</td>`;
    table.appendChild(tr);
    dataRows.push([percent, cdn]);
  }

  box.appendChild(table);
  tableData2 = dataRows;

  const controls = document.createElement("div");
  controls.style.textAlign = "center";
  controls.style.marginTop = "10px";

  const editBtn = document.createElement("button");
  editBtn.className = "edit-btn secondary-btn";
  editBtn.textContent = "üîÅ Edit Data";
  editBtn.onclick = () => { table.remove(); controls.remove(); titleElem.remove(); textarea.style.display = "block"; box.querySelector("button").style.display = "block"; };

  const clearBtn = document.createElement("button");
  clearBtn.className = "secondary-btn";
  clearBtn.style.backgroundColor = "#dc3545";
  clearBtn.textContent = "üßπ Clear Data";
  clearBtn.onclick = () => { table.remove(); controls.remove(); titleElem.remove(); textarea.value = ""; textarea.style.display = "block"; box.querySelector("button").style.display = "block"; tableData2 = []; };

  const copyBtn = document.createElement("button");
  copyBtn.className = "secondary-btn";
  copyBtn.style.backgroundColor = "#28a745";
  copyBtn.textContent = "üìã Copy Data";
  copyBtn.onclick = () => { const textToCopy = dataRows.map(r => r.join("\t")).join("\n"); navigator.clipboard.writeText(textToCopy); alert("‚úÖ Table data copied!"); };

  controls.append(editBtn, clearBtn, copyBtn);
  box.appendChild(controls);
}

function normalize(value, treatCFAC = false) {
  let v = (value || "").toString().trim().replace(/\s+/g, " ").toLowerCase();
  if (treatCFAC) v = v.replace(/-cf-/g, "-ac-");
  return v;
}

function compareTables() {
  const result = document.getElementById("result");
  result.style.display = "block";
  result.className = "result-box";
  result.innerHTML = "";

  if (!tableData1.length || !tableData2.length) {
    result.textContent = "‚ö†Ô∏è Please convert both policy data sets first.";
    result.classList.add("error");
    return;
  }

  const treatCFAC = document.getElementById("cfacCheck").checked;
  let mismatch = false;
  const mismatches = [];
  const maxRows = Math.max(tableData1.length, tableData2.length);

  for (let i = 0; i < maxRows; i++) {
    const row1 = tableData1[i] || ["", ""];
    const row2 = tableData2[i] || ["", ""];
    for (let j = 0; j < 2; j++) {
      if (normalize(row1[j], treatCFAC) !== normalize(row2[j], treatCFAC)) {
        mismatch = true;
        mismatches.push(`Row ${i + 1}, Column ${j + 1}`);
      }
    }
  }

  if (!mismatch) {
    result.textContent = "‚úÖ Policies are matched ‚Äî good to go!";
    result.classList.add("success");
  } else {
    result.classList.add("error");
    result.innerHTML =
      "<strong>‚ùå Mismatch found!</strong><br><ul>" +
      mismatches.map(m => `<li>${m}</li>`).join("") +
      "</ul>";
  }
}
</script>
</body>
</html>
